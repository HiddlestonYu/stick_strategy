# 台指期程式交易看盤室 - 股票城市

## 📊 專案簡介

這是一個基於 Streamlit 開發的台指期貨即時看盤系統，提供互動式 K 線圖表、技術指標分析和多時段交易視圖。適合程式交易員用於快速分析市場走勢、回測策略和監控盤勢。

**主要程式**: `streamlit_run_app.py`

## ✨ 主要功能

### � 雙數據源架構
- **Shioaji API（主要）**：即時台指期貨與台積電資料
  - 支援多合約自動拼接（如 TXF202401, TXF202402...）
  - 完整歷史數據（可達500+日K線）
  - 台指期貨即時行情與市場狀態顯示
- **Yahoo Finance（備用）**：當 Shioaji 數據獲取失敗時自動切換
- **智能切換機制**：優先使用 Shioaji，失敗時無縫切換至 Yahoo Finance

### 📈 多商品支援
- **台灣加權指數（台指期貨）**：使用 Shioaji 即時期貨數據
  - 自動獲取所有可用合約（TXF系列）
  - 多合約數據拼接，完整歷史走勢
- **台積電 (2330.TW)**：Shioaji 即時股票數據
- **台灣加權指數 (^TWII)**：Yahoo Finance 指數數據（備用）

### ⏰ 交易時段切換
- **全盤**：顯示所有交易時段資料
- **日盤**：08:45 - 13:45（一般交易時段）
- **夜盤**：15:00 - 次日 05:00（夜間交易時段）

### 📊 K 線週期選擇
- 分鐘線：1m, 5m, 15m, 30m, 60m
- **日線 (預設)**：適合中長期趨勢分析，自動過濾週末非交易日

### 📏 K 棒數量控制
- **靈活調整**：使用滑桿設定顯示的 K 棒數量（20-500 根）
- **預設值**：100 根 K 棒，平衡性能與資訊量
- **智能資料管理**：根據不同週期自動調整下載期間
  - 日K：2 年資料
  - 30/60分K：60 天資料
  - 15分K：30 天資料
  - 1/5分K：7 天資料

### 📐 技術指標
- **10日均線 (MA10)**：橘色線，短期趨勢指標
- **20日均線 (MA20)**：紫色線，中期趨勢指標
- **成交量柱狀圖**：紅綠配色符合台灣習慣（紅漲綠跌）

### 🖱️ 互動式圖表
- **拖曳平移**：左右拖動查看不同時間段
- **滾輪縮放**：放大縮小查看細節
### 📊 市場狀態即時顯示
- **交易時段自動識別**
  - 🌅 日盤開盤中（08:45-13:45）
  - 🌙 夜盤開盤中（15:00-次日05:00）
  - 💤 休市（盤後時間）
- **數據來源標記**：清楚顯示當前使用 Shioaji 或 Yahoo Finance

## 🛠️ 技術架構

### 核心技術
- **Streamlit**：Web 應用框架
- **Plotly**：互動式圖表庫
- **Shioaji**：永豐金證券 API（主要數據源）
- **yfinance**：Yahoo Finance 數據接口（備用）
- **Pandas**：數據處理與分析

### 資料來源架構
1. **主要來源 - Shioaji API**：
   - 即時台指期貨與台積電數據
   - 多合約自動拼接功能（解決單一合約歷史數據不足問題）
   - 支援市場狀態即時偵測
   
2. **備用來源 - Yahoo Finance**：
   - 當 Shioaji 連線失敗時自動切換
   - 確保系統穩定運行
   
3. **智能切換邏輯**：
   - 優先嘗試 Shioaji API
   - 失敗時自動降級至 Yahoo Finance
   - 在介面清楚標示數據來源

### 核心技術
- **Streamlit**：Web 應用框架
- **Plotly**：互動式圖表庫
- **yfinance**：Yahoo Finance 數據接口
- **Pandas**：數據處理與分析

### 資料來源
- 目前使用 Yahoo Finance API 獲取歷史數據
- 建議實戰使用 **Shioaji API** 接收即時 Tick 資料

## 🚀 快速開始

### 環境需求
- Python 3.9+
- 網路連線（用於下載數據）

### 安裝步驟

1. **克隆專案**
```bash
git clone <repository-url>
cd stick_strategy
```

2. *Shioaji API 設定

**首次使用需要設定永豐金證券 API 帳號：**

1. **申請 API 帳號**：至永豐金證券官網申請 API 使用權限
2. **準備憑證檔案**：下載並放置 `Sinopac.pfx` 憑證於專案根目錄
3. **在應用程式側邊欄填入**：
   - API 金鑰 (API Key)
   - API 密鑰 (API Secret)
   - 憑證密碼 (CA Password)
4. **點擊「登入 Shioaji」按鈕**

**注意事項**：
- Shioaji 帳號需與永豐金證券開戶帳號綁定
- 首次登入需進行身份驗證
- 若無 Shioaji 帳號，系統會自動使用 Yahoo Finance 備用數據源

### 執行應用程式

```bash
# 使用 venv_new 環境執行
streamlit run streamlit_run_app.py
```

應用程式會在瀏覽器自動開啟，預設網址：
- 本地：http://localhost:8501 或 http://localhost:8502
- 網絡：http://192.168.x.x:8501

**建議使用流程**：
1. 先嘗試登入 Shioaji（獲取即時數據）
2. 若無帳號或登入失敗，系統自動使用 Yahoo Finance
3. 選擇商品、時段、週期後開始分析
# Linux/Mac
source venv_new/bin/activate
```

4. **安裝依賴套件**
```bash
pip install -r requirements.txt
```

### 執Shioaji API 整合
- get_shioaji_api(): 建立並快取 Shioaji API 連線
- shioaji_login(): 登入 Shioaji 帳號
- get_market_status(): 即時判斷市場狀態（開盤/休市/日盤/夜盤）
- get_contract(): 獲取交易合約
  * 台指期貨：自動獲取所有可用 TXF 合約（多合約模式）
  * 台積電：獲取單一股票合約

# 4. 數據獲取與處理
- get_data_from_shioaji(): Shioaji API 數據獲取
  * **多合約拼接**：自動遍歷所有 TXF 合約
  * 進度顯示：即時顯示各合約數據獲取進度
  * 欄位標準化：處理不同合約的欄位差異
  * 缺失數據處理：自動處理缺少 volume 等欄位
  * 重複數據去除：按時間戳與成交量去重
  * 時間區間重採樣：統一不同合約的時間間隔
- get_data_from_yahoo(): Yahoo Finance 備份數據源
- filter_by_session(): 根據時段過濾數據
- get_data(): 主要數據獲取函數
  * 優先使用 Shioaji（若已登入）
  * 失敗時自動切換至 Yahoo Finance
  * 智能調整下載期間
  * 時區轉換（台灣時間）
  * 過濾非交易日
  * 計多合約拼接技術**：
   - 自動獲取所有 TXF 期貨合約（如 TXF202401, TXF202402...）
   - 逐一獲取各合約歷史數據並拼接
   - 按時間戳排序並去除重複數據
   - 解決單一合約僅有 1 個月數據的限制
   - 實現完整歷史走勢（500+ 日K線）

2. **雙數據源容錯機制**：
   - Shioaji 為主，Yahoo Finance 為備
   - 自動偵測連線狀態並切換
   - 無縫降級確保服務穩定

3. **資料快取機制**：
   - `@st.cache_resource`：快取 API 連線物件
   - `@st.cache_data(ttl=60)`：快取數據 60 秒減少重複請求

4. **時區處理**：自動轉換為台灣時區（Asia/Taipei）

5. **非交易時間過濾**：
   - 日K 自動移除週末
   - 分鐘K 支援日盤/夜盤時段過濾

6. **市場狀態即時判斷**：
   - 根據台灣時間自動判斷開盤/休市
   - 區分日盤/夜盤時段

7. **錯誤處理**：完整的 try-except 機制保證穩定性

8
```
stick_strategy/
│
├── streamlit_run_app.py       # 主應用程式（股票城市 - 最新版）
├── streamlit_app_new.py       # 另一版本應用程式
#### Shioaji 多合約拼接流程
1. **獲取所有合約**：自動獲取所有可用 TXF 期貨合約
2. **逐一獲取數據**：
   - 迴圈遍歷每個合約（如 TXF202401, TXF202402...）
   - 呼叫 `api.kbars()` 獲取各合約歷史數據
   - 顯示進度：「📥 正在獲取 TXF202401 數據... (1/12)」
3. **欄位標準化處理**：
   - 檢查欄位是否存在（防止 KeyError）
   - 統一欄位命名：ts, Open, High, Low, Close, Volume
   - 缺失欄位填充預設值（Volume=0）
4. **數據拼接**：
   - 使用 `pd.concat()` 合併所有合約數據
   - 按 Volume 排序去除重複時間戳
   - 按時間索引重新排序
5. **時間區間統一**：檢查並重採樣至目標週期（1d, 60m 等）

#### 通用處理流程
1. **時區轉換**：UTC → Asia/Taipei（台灣時間）
2. **時段過濾**：
   - 日盤：08:45-13:45
   - 夜盤：15:00-次日05:00
   - 全盤：不過濾
3. **非交易日移除**：日K 自動過濾週末
4. **技術指標計算**：
   - MA10 = Close.rolling(10).mean()
   - MA20 = Close.rolling(20).mean()
5## streamlit_run_app.py 核心結構

```python
# 1. 頁面初始化設定
- 設定頁面配置和標題

# 2. 側邊欄控制項
- 商品選擇（台指期/台積電/加權指數）
- 時段選擇（全盤/日盤/夜盤）
- K線週期選擇（1m-1d）
- K棒數量滑桿（20-500根）

# 3. 數據獲取與處理
- get_ticker_symbol(): 轉換商品名稱為股票代碼
- filter_by_session(): 根據時段過濾數據
- gx] 整合 Shioaji API 接收即時資料 ✅
- [x] 多合約自動拼接（解決歷史數據不足問題）✅
- [x] 市場狀態即時顯示 ✅
- [x] 雙數據源容錯機制 ✅
- [ ] 新增更多技術指標（RSI, MACD, KD, 布林通道）
- [ ] 支援多商品對比分析（雙視窗比較）
- [ ] 新增策略回測功能與績效統計
- [ ] 加入自動交易訊號提示（均線交叉、突破訊號）
- [ ] 支援多時間框架分析（MTF）
- [ ] 加入警報功能（價格突破、指標交叉）
- [ ] 歷史數據匯出功能（CSV/Excel）
- [ ]Shioaji API 使用**：
   - 需要永豐金證券 API 帳號與憑證
   - 首次登入需進行身份驗證
   - 多合約拼接需要時間（12 個合約約需 10-15 秒）
   - 若無帳號，系統會自動使用 Yahoo Finance

2. **數據限制**：
   - Yahoo Finance 對分鐘線數據有時間限制
   - Shioaji 單一合約僅約 1 個月歷史數據
   - 系統已實作多合約拼接解決此問題
   - 建議使用日K查看長期走勢

3. **數據延遲**：
   - Shioaji：準即時數據（延遲約數秒）
   - Yahoo Finance：歷史數據（延遲約 15-20 分鐘）

4. **僅供學習**：
   - 本專案僅供教育和研究用途
   - 不構成投資建議
   - 實際交易請審慎評估風險

5. **效能考量**：
   - 多合約拼接會增加載入時間盤/夜盤時段過濾
4. **錯誤處理**：完整的 try-except 機制保證穩定性
5. **響應式設計**：圖表自動適應瀏覽器寬度
3.0 (2026-01-19) - 多合約拼接版
- ✅ **整合 Shioaji API 主數據源**
  - 即時台指期貨與台積電數據
  - 自動登入與連線管理
  - API 連線狀態快取
- ✅ **多合約自動拼接功能**
  - 自動獲取所有 TXF 期貨合約
  - 逐一獲取各合約歷史數據
  - 智能拼接與去重處理
  - 完整歷史走勢（500+ 日K線）
  - 進度顯示與錯誤處理
- ✅ **市場狀態即時顯示**
  - 自動判斷開盤/休市
  - 區分日盤/夜盤時段
  - 顯示數據來源標記
- ✅ **雙數據源容錯機制**
  - Shioaji 為主，Yahoo Finance 為備
  - 自動切換確保穩定運行
- ✅ **欄位標準化處理**
  - 處理不同合約欄位差異
  - 缺失數據自動填充
  - 防止 KeyError 異常
- ✅ **更新 README 完整文件**

### v2.0 (2026-01-13)
- ✅ 預設改為日K線圖
- ✅ 新增K棒數量控制滑桿（20-500根）
- ✅ 智能調整下載期間（根據週期）
- ✅ 自動過濾週末非交易日
- ✅ 修正 Streamlit 棄用警告
- ✅ 加入完整程式註解
### 2. 波段交易
- 使用日K線配合 MA 指標捕捉趨勢
- 設定較多 K 棒數（100-200根）觀察中期走勢
- 自動過濾週末，圖表更清晰

### 3. 策略回測
- 切換不同週期驗證策略有效性
- 觀察均線交叉點位
- 分析成交量與價格關係

### 4. 盤勢監控
- 即時觀察最新收盤價與均線關係
- 成交量變化輔助判斷多空力道
- 深色主題降低長時間觀看疲勞

## 🔧 技術細節

### 資料處理流程

1. **數據下載**：使用 yfinance 從 Yahoo Finance 下載歷史數據
2. **時區轉換**：UTC → Asia/Taipei（台灣時間）
3. **欄位標準化**：統一為 Open, High, Low, Close, Volume
4. **時段過濾**：
   - 日盤：08:45-13:45
   - 夜盤：15:00-次日05:00
   - 全盤：不過濾
5. **非交易日移除**：日K 自動過濾週末
6. **技術指標計算**：
   - MA10 = Close.rolling(10).mean()
   - MA20 = Close.rolling(20).mean()
7. **數量限制**：取最新的 N 根 K 棒

### 效能優化

- **快取機制**：60秒內相同參數不重複下載
- **智能期間**：根據週期自動調整下載範圍
- **數量限制**：避免過多資料造成渲染延遲
- **條件渲染**：只在有數據時繪製圖表

## 🔄 未來規劃

- [ ] 整合 Shioaji API 接收即時 Tick 資料
- [ ] 新增更多技術指標（RSI, MACD, KD, 布林通道）
- [ ] 支援多商品對比分析（雙視窗比較）
- [ ] 新增策略回測功能與績效統計
- [ ] 加入自動交易訊號提示（均線交叉、突破訊號）
- [ ] 支援多時間框架分析（MTF）
- [ ] 加入警報功能（價格突破、指標交叉）
- [ ] 歷史數據匯出功能（CSV/Excel）

## ⚠️ 注意事項

1. **數據限制**：
   - Yahoo Finance 對分鐘線數據有時間限制
   - 建議使用日K查看長期走勢
   - 分鐘K適合觀察近期盤勢

2. **非即時數據**：
   - 目前使用的是歷史數據，延遲約15-20分鐘
   - 實戰交易請使用即時數據源（如 Shioaji）

3. **僅供學習**：
   - 本專案僅供教育和研究用途
   - 不構成投資建議
   - 實際交易請審慎評估風險

4. **模擬環境**：
   - 使用台灣加權指數模擬台指期
   - 實際交易請使用正式期貨數據

5. **效能考量**：
   - K棒數量過多可能影響渲染速度
   - 建議依需求調整顯示數量
   - 使用快取機制避免頻繁請求

## 🆕 更新日誌

### v2.0 (2026-01-13)
- ✅ 預設改為日K線圖
- ✅ 新增K棒數量控制滑桿（20-500根）
- ✅ 智能調整下載期間（根據週期）
- ✅ 自動過濾週末非交易日
- ✅ 修正 Streamlit 棄用警告
- ✅ 加入完整程式註解
- ✅ 更新 README 文件

### v1.0
- 初始版本
- 基本K線圖表功能
- MA10/MA20 技術指標
- 時段切換功能

## 📝 依賴套件

```txt
yfinance>=0.2.31
mplfinance>=0.12.10b0
pandas>=2.0.0
matplotlib>=3.7.0
shioaji[speed]>=1.0.0
pathlib>=1.0.1
streamlit
plotly
numpy
```

## 🤝 貢獻

歡迎提交 Issue 和 Pull Request 來改進這個專案！

## 📄 授權

本專案採用 MIT 授權條款

## 👨‍💻 開發者

本專案由 AI 助手協助開發完成

## 📧 聯絡資訊

如有問題或建議，歡迎透過 GitHub Issues 提出

---

**⚡ 快速開始：`streamlit run streamlit_run_app.py`**

**🎯 推薦設定：日K線 + 100根K棒 + 全盤時段**
