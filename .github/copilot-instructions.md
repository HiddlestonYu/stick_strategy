# 股票城市 (Stock City) 專案指引

## 📌 專案概述
這是一個基於 Streamlit 的台股期貨即時交易儀表板，主要功能包括：
- 台指期貨 (TXF) 即時 K 線圖表
- Shioaji API 整合（主要數據源）
- Yahoo Finance 備援機制
- 日盤/夜盤市場狀態偵測
- 自動刷新機制（1-60 秒可調）

## 🎯 核心技術棧
- **前端框架**: Streamlit 1.28.0+
- **圖表庫**: Plotly 5.17.0+
- **數據源**: Shioaji 1.3.1 (主要) / yfinance 0.2.31+ (備援)
- **Python 版本**: 3.14.2
- **時區處理**: pytz (Asia/Taipei)

## 💻 編碼規範

### 命名慣例
- 函數名稱：使用 `snake_case`（如 `get_data_from_shioaji`）
- 變數名稱：使用 `snake_case`（如 `market_status`）
- 常數：使用 `UPPER_SNAKE_CASE`（如 `DEFAULT_INTERVAL`）
- 註解和字串：使用**繁體中文**

### 資料處理原則
- 所有時間戳必須轉換為 `Asia/Taipei` 時區
- DataFrame 的時間欄位統一命名為 `ts`（timestamp）
- K 線數據必須包含：Open, High, Low, Close, Volume

### 快取策略
- **即時數據** (Shioaji): `@st.cache_data(ttl=3)` - 3 秒快取
- **歷史數據** (Yahoo Finance): `@st.cache_data(ttl=60)` - 60 秒快取
- 避免過度快取導致數據不即時

## 🔧 開發規則

### API 連線管理
1. 每次登入前必須先檢查並關閉舊連線
2. 連線失敗時等待 2 秒後重試
3. 提供「登出」和「強制重置」兩種斷線機制
4. 顯示詳細的錯誤訊息和解決步驟

### 自動刷新機制
- 僅在 `is_realtime=True` 時啟用自動刷新
- 使用 `st.empty()` + `time.sleep(1)` 實現倒數計時
- 刷新間隔預設 3 秒，可調範圍 1-60 秒
- 避免在非市場時段頻繁刷新

### 錯誤處理
- 所有 API 呼叫都必須包在 `try-except` 中
- 404 錯誤時自動縮短時間範圍重試
- Shioaji 失敗時自動切換到 Yahoo Finance
- 顯示清晰的中文錯誤訊息給使用者

## 📊 資料顯示規範

### 狀態欄位
必須顯示以下三個狀態：
1. **資料來源**: Shioaji API / Yahoo Finance
2. **資料類型**: 即時資料 / 歷史資料
3. **更新時間**: 台灣時間 (HH:MM:SS)

### K 線圖表設定
- 高度：900px
- 蠟燭線寬度：2px
- Y 軸：自動縮放（`autorange=True`）
- 顏色：上漲紅色 (#FF6B6B) / 下跌綠色 (#4ECDC4)

## 🚫 禁止事項

### Git 操作
- **絕對不要自動執行 `git commit` 或 `git push`**
- 必須先詢問使用者意願
- Commit message 使用繁體中文
- 不要提交敏感檔案（.pfx, .env, .log）

### 程式碼修改
- 不要刪除現有的錯誤處理邏輯
- 不要移除市場時段判斷功能
- 不要改變核心資料結構（DataFrame 欄位名稱）
- 修改快取設定前必須說明理由

## 🔍 偵錯原則

### 數據不更新時檢查順序
1. 檢查市場是否開盤（日盤/夜盤時段）
2. 檢查自動刷新是否啟用
3. 檢查快取 TTL 設定（是否過長）
4. 檢查 Shioaji 連線狀態
5. 查看側邊欄的詳細錯誤訊息

### 效能優化考量
- 避免在迴圈中呼叫 Streamlit 元件
- 大量資料讀取時考慮分批處理
- 使用 `st.spinner()` 顯示載入狀態
- 非必要不使用 `maxResults` 參數

## 📝 回應格式

### 使用繁體中文
- 所有回應、註解、Commit message 使用繁體中文
- 技術術語可保留英文（如 "DataFrame", "API"）
- 錯誤訊息顯示中英對照

### 簡潔明確
- 直接回答問題，避免冗長說明
- 完成檔案操作後簡短確認即可
- 複雜修改時才需要詳細說明

## 🎓 專案特定知識

### 台指期貨交易時段
- **日盤**: 08:45 - 13:45
- **夜盤**: 15:00 - 05:00 (隔日)
- 非交易時段自動切換到歷史資料模式

### Shioaji 合約選擇
- 使用最近月合約（`contract_list[0]`）
- 顯示合約代碼和到期日
- 避免多合約拼接（會導致資料延遲）

### 時間範圍設定
- 1 分/5 分 K：12 小時
- 15 分 K：2 天
- 30 分/60 分 K：3 天
- 日 K：30 天

---

**最後更新**: 2026-01-24  
**維護者**: Hiddleston  
**專案位置**: `d:\Hiddleston\stick_strategy`
