# 專案流程圖（Phase 1~3）

本文件用來讓你審視整體專案走向，並作為後續 Phase 2/3 開發時的共同語言。

## 流程圖（Mermaid）

```mermaid
flowchart TD
    %% =========================
    %% Phase 1 - 看盤軟體
    %% =========================
    subgraph P1[Phase 1：看盤軟體環境建置（已完成/進行中）]
      A[Shioaji API\nTXFR1 / api.kbars()] --> B[資料標準化\nAsia/Taipei 時區\n1分K欄位統一]
      B --> C[SQLite\ndata/txf_ticks.db\n儲存 1分K 當作 ticks]
      C --> D[DB 端重組\n5m/15m/30m/60m/1d\nright/right 對齊]
      D --> E[Streamlit UI\nK線 + MA + Volume]
      E --> F[市場狀態\n日盤/夜盤/全盤\n自動刷新]
      E --> G[DB 存量提示\n日K根數/範圍]
      F --> H[登入後自動回填\n日K不足 => 分批補齊]
      H --> C
    end

    %% =========================
    %% Phase 2 - 策略標示
    %% =========================
    subgraph P2[Phase 2：策略方案視覺化（你提供多空方案）]
      I[策略規則輸入\n（多空進出場條件）] --> J[訊號產生器\nEntry/Exit/Stop/TP]
      J --> K[圖表疊加層\n支撐/壓力線、點\n進出場標記]
      K --> E
      L[參數管理\n版本化/可回放] --> J
    end

    %% =========================
    %% Phase 3 - 回測/績效
    %% =========================
    subgraph P3[Phase 3：回測方案 + 成本 + 獲利計算]
      C --> M[回測資料集\n從 DB 取指定期間\n可切 1m/5m/15m...]
      I --> N[回測引擎\n逐K/逐bar 模擬]
      M --> N
      O[交易成本\n大台/小台手續費\n滑價(可選)] --> N
      N --> P[績效輸出\nPnL、勝率、MDD\n交易明細]
      P --> Q[報表\nStreamlit 顯示\n匯出 CSV]
    end

    %% 共用：憑證/安全
    subgraph SEC[共用：憑證與安全（不進 Git）]
      S1[環境變數\nSHIOAJI_API_KEY/SECRET] --> E
      S2[Streamlit secrets\n.streamlit/secrets.toml\n（本機檔）] --> E
    end
```

## 各 Phase 交付物（你審視用）

### Phase 1（看盤軟體）
- 資料：以 SQLite 儲存 1分K（作為 ticks），DB 端重組 5m/15m/30m/60m/1d
- UI：時段（日/夜/全盤）、週期、K棒數量滑桿、DB 日K存量顯示、即時狀態
- 可靠性：夜盤跨日/05:00、結算日 13:30、時區一致、資料不足自動回填

### Phase 2（策略視覺化）
- 你提供多空方案後，我會把條件轉成：
  - 支撐/壓力：線（水平/趨勢）+ 點（關鍵價位）
  - 進場/出場：Plotly marker + 文字標籤（可選）
  - 風控：停損/停利線（可選）

### Phase 3（回測與績效）
- 你提供：大台/小台手續費（以及是否含交易稅/滑價假設）
- 輸出：每筆交易明細、總損益、最大回撤、勝率、期望值等

## 我需要你在 Phase 2/3 提供的資訊（清單）
- Phase 2：
  - 進場條件（多/空）、出場條件、停損/停利、是否允許反手
  - 用哪個週期判斷（1m/5m/15m/60m/1d）、是否只做日盤/夜盤/全盤
- Phase 3：
  - 大台(TXF)/小台(MTX) 每口手續費（進+出 或單邊）
  - 是否納入滑價（固定點數或依波動）
  - 回測期間與初始資金/是否限制同時持倉
