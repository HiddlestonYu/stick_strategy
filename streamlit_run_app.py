"""
å°æŒ‡æœŸç¨‹å¼äº¤æ˜“çœ‹ç›¤å®¤ - è‚¡ç¥¨åŸå¸‚
=====================================================
æœ¬ç¨‹å¼æä¾›å°æŒ‡æœŸè²¨ã€å°ç©é›»å’Œå°ç£åŠ æ¬ŠæŒ‡æ•¸çš„ K ç·šåœ–è¡¨åˆ†æå·¥å…·
æ”¯æ´å¤šæ™‚æ®µåˆ‡æ›ï¼ˆæ—¥ç›¤/å¤œç›¤/å…¨ç›¤ï¼‰ã€å¤šé€±æœŸ K ç·šï¼ˆ1åˆ†-æ—¥ç·šï¼‰
ä¸¦åŒ…å«ç§»å‹•å¹³å‡ç·šï¼ˆMA10/MA20ï¼‰æŠ€è¡“æŒ‡æ¨™

ä½œè€…: AI Assistant
ç‰ˆæœ¬: 2.0
æ—¥æœŸ: 2026-01-13
"""

import streamlit as st  # Streamlit Web æ¡†æ¶ï¼Œç”¨æ–¼å»ºç«‹äº’å‹•å¼ç¶²é æ‡‰ç”¨
import plotly.graph_objects as go  # Plotly åœ–è¡¨ç‰©ä»¶ï¼Œç”¨æ–¼ç¹ªè£½äº’å‹•å¼åœ–è¡¨
from plotly.subplots import make_subplots  # Plotly å­åœ–åŠŸèƒ½ï¼Œç”¨æ–¼å»ºç«‹å¤šè»¸åœ–è¡¨
import yfinance as yf  # Yahoo Finance APIï¼Œç”¨æ–¼ä¸‹è¼‰è‚¡ç¥¨æ­·å²æ•¸æ“š
import pandas as pd  # Pandas æ•¸æ“šè™•ç†åº«ï¼Œç”¨æ–¼è³‡æ–™åˆ†æå’Œè™•ç†

# ============================================================
# 1. é é¢åˆå§‹åŒ–è¨­å®š
# ============================================================
# è¨­å®šé é¢é…ç½®ï¼šä½¿ç”¨å¯¬ç‰ˆé¢ä¸¦è‡ªè¨‚æ¨™é¡Œ
st.set_page_config(layout="wide", page_title="å°æŒ‡æœŸç¨‹å¼äº¤æ˜“çœ‹ç›¤å®¤")

# é¡¯ç¤ºä¸»æ¨™é¡Œ
st.title("ğŸ“ˆ å°æŒ‡æœŸå…¨ç›¤ Kç·šåœ– (å« 10MA/20MA)")

# ============================================================
# 2. å´é‚Šæ¬„æ§åˆ¶é …
# ============================================================
# ä½¿ç”¨ Streamlit çš„ sidebar åŠŸèƒ½å»ºç«‹åƒæ•¸æ§åˆ¶é¢æ¿
with st.sidebar:
    st.header("åƒæ•¸è¨­å®š")
    
    # ------------------------------------------------------------
    # 2.1 å•†å“é¸æ“‡ä¸‹æ‹‰é¸å–®
    # ------------------------------------------------------------
    # æä¾›ä¸‰ç¨®å•†å“é¸é …ä¾›ä½¿ç”¨è€…é¸æ“‡
    # index=0 è¡¨ç¤ºé è¨­é¸æ“‡ç¬¬ä¸€å€‹é¸é …ï¼ˆå°æŒ‡æœŸæ¨¡æ“¬ï¼‰
    product_option = st.selectbox(
        "é¸æ“‡å•†å“",
        ("å°æŒ‡æœŸ (æ¨¡æ“¬)", "å°ç©é›» (2330.TW)", "å°ç£åŠ æ¬ŠæŒ‡æ•¸ (^TWII)"),
        index=0
    )
    
    # ------------------------------------------------------------
    # 2.2 äº¤æ˜“æ™‚æ®µé¸æ“‡
    # ------------------------------------------------------------
    # å…¨ç›¤ï¼šé¡¯ç¤ºæ‰€æœ‰äº¤æ˜“æ™‚æ®µ
    # æ—¥ç›¤ï¼š08:45 - 13:45
    # å¤œç›¤ï¼š15:00 - æ¬¡æ—¥ 05:00
    session_option = st.selectbox(
        "é¸æ“‡æ™‚æ®µ",
        ("å…¨ç›¤", "æ—¥ç›¤", "å¤œç›¤"),
        index=0
    )
    
    # ------------------------------------------------------------
    # 2.3 Kç·šé€±æœŸé¸æ“‡
    # ------------------------------------------------------------
    # æ”¯æ´å¾ 1 åˆ†é˜åˆ°æ—¥ç·šçš„å¤šç¨®æ™‚é–“é€±æœŸ
    # index=5 è¡¨ç¤ºé è¨­é¸æ“‡æ—¥Kï¼ˆ1dï¼‰
    interval_option = st.selectbox(
        "é¸æ“‡ K ç·šé€±æœŸ",
        ("1m", "5m", "15m", "30m", "60m", "1d"),
        index=5  # é è¨­ æ—¥K
    )
    
    # ------------------------------------------------------------
    # 2.4 æœ€å¤§Kæ£’æ•¸é‡æ»‘æ¡¿
    # ------------------------------------------------------------
    # é™åˆ¶åœ–è¡¨é¡¯ç¤ºçš„ K æ£’æ•¸é‡ï¼Œé¿å…è³‡æ–™éå¤šå°è‡´æ•ˆèƒ½å•é¡Œ
    # ç¯„åœï¼š20-500 æ ¹ï¼Œé è¨­ 100 æ ¹ï¼Œæ¯æ¬¡èª¿æ•´ 10 æ ¹
    max_kbars = st.slider(
        "é¡¯ç¤ºKæ£’æ•¸é‡",
        min_value=20,
        max_value=500,
        value=100,
        step=10,
        help="è¨­å®šåœ–è¡¨é¡¯ç¤ºçš„æœ€å¤§Kæ£’æ•¸é‡"
    )
    
    # é¡¯ç¤ºæç¤ºè¨Šæ¯
    st.info("ğŸ’¡ æç¤ºï¼šå¯¦æˆ°ä¸­å»ºè­°ä½¿ç”¨ Shioaji API æ¥æ”¶ Tick è³‡æ–™ä¸¦å³æ™‚åˆæˆ K æ£’ã€‚")
    st.info(f"ğŸ“Š ç•¶å‰æ™‚æ®µï¼š{session_option}")

# ============================================================
# 3. æ•¸æ“šç²å–èˆ‡è™•ç† (Data Handler)
# ============================================================

def get_ticker_symbol(product):
    """
    æ ¹æ“šä½¿ç”¨è€…é¸æ“‡çš„å•†å“è¿”å›å°æ‡‰çš„ Yahoo Finance è‚¡ç¥¨ä»£ç¢¼
    
    åƒæ•¸:
        product (str): ä½¿ç”¨è€…é¸æ“‡çš„å•†å“åç¨±
        
    è¿”å›:
        str: Yahoo Finance çš„è‚¡ç¥¨ä»£ç¢¼
        
    èªªæ˜:
        - å°æŒ‡æœŸä½¿ç”¨åŠ æ¬ŠæŒ‡æ•¸(^TWII)æ¨¡æ“¬
        - å°ç©é›»ä»£ç¢¼ç‚º 2330.TW
        - åŠ æ¬ŠæŒ‡æ•¸ä»£ç¢¼ç‚º ^TWII
    """
    if product == "å°æŒ‡æœŸ (æ¨¡æ“¬)":
        return "^TWII"  # ä½¿ç”¨å°ç£åŠ æ¬ŠæŒ‡æ•¸æ¨¡æ“¬å°æŒ‡æœŸ
    elif product == "å°ç©é›» (2330.TW)":
        return "2330.TW"
    elif product == "å°ç£åŠ æ¬ŠæŒ‡æ•¸ (^TWII)":
        return "^TWII"
    return "^TWII"  # é è¨­è¿”å›åŠ æ¬ŠæŒ‡æ•¸

def filter_by_session(df, session):
    """
    æ ¹æ“šé¸æ“‡çš„äº¤æ˜“æ™‚æ®µéæ¿¾ K ç·šæ•¸æ“š
    
    åƒæ•¸:
        df (pd.DataFrame): K ç·šæ•¸æ“šçš„ DataFrame
        session (str): æ™‚æ®µé¸æ“‡ - "æ—¥ç›¤", "å¤œç›¤" æˆ– "å…¨ç›¤"
        
    è¿”å›:
        pd.DataFrame: éæ¿¾å¾Œçš„ K ç·šæ•¸æ“š
        
    äº¤æ˜“æ™‚æ®µèªªæ˜:
        - æ—¥ç›¤ï¼š08:45 - 13:45 (ä¸€èˆ¬äº¤æ˜“æ™‚æ®µ)
        - å¤œç›¤ï¼š15:00 - æ¬¡æ—¥ 05:00 (å¤œé–“äº¤æ˜“æ™‚æ®µ)
        - å…¨ç›¤ï¼šé¡¯ç¤ºæ‰€æœ‰æ™‚æ®µè³‡æ–™
    """
    # æª¢æŸ¥ DataFrame æ˜¯å¦ç‚ºç©º
    if df is None or df.empty:
        return df
    
    # ç¢ºä¿ç´¢å¼•å…·æœ‰æ™‚å€è³‡è¨Šï¼ˆå°ç£æ™‚é–“ï¼‰
    if df.index.tz is None:
        df.index = df.index.tz_localize('Asia/Taipei')
    
    # å¾ DataFrame ç´¢å¼•ä¸­æå–å°æ™‚å’Œåˆ†é˜è³‡è¨Š
    hours = df.index.hour
    minutes = df.index.minute
    
    # æ ¹æ“šé¸æ“‡çš„æ™‚æ®µå»ºç«‹éæ¿¾æ¢ä»¶
    if session == "æ—¥ç›¤":
        # æ—¥ç›¤æ™‚æ®µï¼š08:45 - 13:45
        # åŒ…å« 8 é» 45 åˆ†ä¹‹å¾Œã€9-12 é»æ•´é»ã€13 é» 45 åˆ†ä¹‹å‰
        mask = ((hours == 8) & (minutes >= 45)) | \
               ((hours >= 9) & (hours < 13)) | \
               ((hours == 13) & (minutes <= 45))
        return df[mask]
    elif session == "å¤œç›¤":
        # å¤œç›¤æ™‚æ®µï¼š15:00 - æ¬¡æ—¥ 05:00
        # åŒ…å« 15 é»ä¹‹å¾Œåˆ° 5 é»ä¹‹å‰ï¼ˆè·¨æ—¥ï¼‰
        mask = (hours >= 15) | (hours < 5)
        return df[mask]
    else:  # å…¨ç›¤
        # è¿”å›æ‰€æœ‰è³‡æ–™ä¸éæ¿¾
        return df

@st.cache_data(ttl=60)  # ä½¿ç”¨ Streamlit å¿«å–æ©Ÿåˆ¶ï¼Œ60 ç§’å…§é¿å…é‡è¤‡è«‹æ±‚ç›¸åŒè³‡æ–™
def get_data(interval, product, session):
    """
    å¾ Yahoo Finance ä¸‹è¼‰ä¸¦è™•ç†è‚¡ç¥¨ K ç·šæ•¸æ“š
    
    åƒæ•¸:
        interval (str): K ç·šé€±æœŸ - "1m", "5m", "15m", "30m", "60m", "1d"
        product (str): å•†å“åç¨±
        session (str): äº¤æ˜“æ™‚æ®µ - "æ—¥ç›¤", "å¤œç›¤", "å…¨ç›¤"
        
    è¿”å›:
        pd.DataFrame: åŒ…å« OHLCV å’ŒæŠ€è¡“æŒ‡æ¨™çš„ DataFrameï¼Œè‹¥å¤±æ•—å‰‡è¿”å› None
        
    è³‡æ–™æ¬„ä½:
        - Open: é–‹ç›¤åƒ¹
        - High: æœ€é«˜åƒ¹
        - Low: æœ€ä½åƒ¹
        - Close: æ”¶ç›¤åƒ¹
        - Volume: æˆäº¤é‡
        - MA10: 10 æ—¥ç§»å‹•å¹³å‡ç·š
        - MA20: 20 æ—¥ç§»å‹•å¹³å‡ç·š
        
    æ³¨æ„:
        å¯¦æˆ°ç’°å¢ƒå»ºè­°ä½¿ç”¨ Shioaji API: api.kline(contract, min_volume=1)
    """
    # å–å¾—å°æ‡‰çš„è‚¡ç¥¨ä»£ç¢¼
    ticker = get_ticker_symbol(product)
    
    # ------------------------------------------------------------
    # æ ¹æ“š K ç·šé€±æœŸèª¿æ•´ä¸‹è¼‰æœŸé–“
    # ------------------------------------------------------------
    # Yahoo Finance å°ä¸åŒé€±æœŸæœ‰æ•¸æ“šé‡é™åˆ¶ï¼Œéœ€è¦åˆç†è¨­å®šä¸‹è¼‰æœŸé–“
    if interval == "1d":
        period = "2y"  # æ—¥Kï¼šä¸‹è¼‰ 2 å¹´è³‡æ–™ï¼ˆç´„ 500 å€‹äº¤æ˜“æ—¥ï¼‰
    elif interval in ["30m", "60m"]:
        period = "60d"  # 30åˆ†/60åˆ†Kï¼šä¸‹è¼‰ 60 å¤©è³‡æ–™
    elif interval in ["15m"]:
        period = "30d"  # 15åˆ†Kï¼šä¸‹è¼‰ 30 å¤©è³‡æ–™
    else:
        period = "7d"  # 1åˆ†/5åˆ†Kï¼šä¸‹è¼‰ 7 å¤©è³‡æ–™
    
    # ------------------------------------------------------------
    # ä¸‹è¼‰æ•¸æ“šä¸¦é€²è¡ŒéŒ¯èª¤è™•ç†
    # ------------------------------------------------------------
    try:
        # progress=False é¿å…é¡¯ç¤ºä¸‹è¼‰é€²åº¦æ¢
        df = yf.download(ticker, period=period, interval=interval, progress=False)
    except Exception as e:
        st.error(f"æ•¸æ“šä¸‹è¼‰å¤±æ•—: {e}")
        return None
    
    # æª¢æŸ¥æ˜¯å¦æˆåŠŸä¸‹è¼‰åˆ°æ•¸æ“š
    if df.empty:
        return None
    
    # ------------------------------------------------------------
    # è³‡æ–™æ¸…ç†èˆ‡æ¨™æº–åŒ–
    # ------------------------------------------------------------
    # è™•ç†å¤šå±¤ç´¢å¼•çš„æ¬„ä½åç¨±ï¼ˆç•¶ä¸‹è¼‰å¤šå€‹è‚¡ç¥¨æ™‚æœƒå‡ºç¾ï¼‰
    if isinstance(df.columns, pd.MultiIndex):
        df.columns = df.columns.get_level_values(0)
    
    # æ¨™æº–åŒ–æ¬„ä½åç¨±ï¼šç¢ºä¿é¦–å­—æ¯å¤§å¯«ï¼ˆOpen, High, Low, Close, Volumeï¼‰
    df.columns = [col.capitalize() for col in df.columns]
    
    # ------------------------------------------------------------
    # æ™‚å€è½‰æ›
    # ------------------------------------------------------------
    # å°‡æ™‚é–“ç´¢å¼•è½‰æ›ç‚ºå°ç£æ™‚é–“ï¼ˆAsia/Taipeiï¼‰
    try:
        # å¦‚æœå·²æœ‰æ™‚å€è³‡è¨Šï¼Œç›´æ¥è½‰æ›
        df.index = df.index.tz_convert('Asia/Taipei')
    except TypeError:
        # å¦‚æœæ²’æœ‰æ™‚å€è³‡è¨Šï¼Œå…ˆè¨­å®šç‚º UTC å†è½‰æ›ç‚ºå°ç£æ™‚é–“
        df.index = df.index.tz_localize('UTC').tz_convert('Asia/Taipei')
    
    # ------------------------------------------------------------
    # éæ¿¾éäº¤æ˜“æ™‚é–“
    # ------------------------------------------------------------
    # æ—¥K ç·šç§»é™¤é€±æœ«ï¼ˆé€±å…­=5, é€±æ—¥=6ï¼‰
    if interval == "1d":
        df = df[df.index.dayofweek < 5]
    
    # æ ¹æ“šä½¿ç”¨è€…é¸æ“‡çš„æ™‚æ®µéæ¿¾æ•¸æ“šï¼ˆæ—¥ç›¤/å¤œç›¤/å…¨ç›¤ï¼‰
    df = filter_by_session(df, session)
    
    # å†æ¬¡æª¢æŸ¥éæ¿¾å¾Œæ˜¯å¦é‚„æœ‰æ•¸æ“š
    if df.empty:
        return None
    
    # ------------------------------------------------------------
    # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
    # ------------------------------------------------------------
    # è¨ˆç®— 10 æ—¥ç§»å‹•å¹³å‡ç·šï¼ˆMA10ï¼‰
    # rolling(window=10) å»ºç«‹ 10 å€‹æ•¸æ“šé»çš„æ»¾å‹•è¦–çª—
    # mean() è¨ˆç®—è¦–çª—å…§çš„å¹³å‡å€¼
    df['MA10'] = df['Close'].rolling(window=10).mean()
    
    # è¨ˆç®— 20 æ—¥ç§»å‹•å¹³å‡ç·šï¼ˆMA20ï¼‰
    df['MA20'] = df['Close'].rolling(window=20).mean()
    
    return df

# ============================================================
# 4. ä¸»ç¨‹å¼åŸ·è¡Œï¼šç²å–æ•¸æ“šä¸¦é™åˆ¶Kæ£’æ•¸é‡
# ============================================================
# å‘¼å« get_data å‡½æ•¸ç²å– K ç·šæ•¸æ“š
df = get_data(interval_option, product_option, session_option)

# æ ¹æ“šä½¿ç”¨è€…è¨­å®šçš„æœ€å¤§Kæ£’æ•¸é™åˆ¶è³‡æ–™é‡
# ä½¿ç”¨ tail() å–å¾Œé¢çš„ N ç­†è³‡æ–™ï¼Œä¿ç•™æœ€æ–°çš„ K æ£’
if df is not None and len(df) > max_kbars:
    df = df.tail(max_kbars)

# ============================================================
# 5. ç¹ªè£½äº’å‹•å¼ K ç·šåœ– (Visualization)
# ============================================================
if df is not None:
    # ------------------------------------------------------------
    # 5.0 å»ºç«‹é€£çºŒçš„ x è»¸ç´¢å¼•ï¼ˆç§»é™¤æ‰€æœ‰ç©ºç™½é–“éš™ï¼‰
    # ------------------------------------------------------------
    # å°‡æ™‚é–“ç´¢å¼•è½‰æ›ç‚ºå­—ä¸²æ ¼å¼ï¼Œç”¨æ–¼é¡¯ç¤º
    date_labels = df.index.strftime('%Y-%m-%d %H:%M') if len(df) > 0 and hasattr(df.index[0], 'strftime') else df.index.astype(str)
    # å»ºç«‹é€£çºŒçš„æ•¸å­—ç´¢å¼•ï¼ˆ0, 1, 2, 3...ï¼‰ç¢ºä¿æ²’æœ‰ä»»ä½•ç©ºç™½
    x_range = list(range(len(df)))
    
    # ------------------------------------------------------------
    # 5.1 å»ºç«‹é›™è»¸åœ–è¡¨ (Kç·š + æˆäº¤é‡)
    # ------------------------------------------------------------
    # ä½¿ç”¨ Plotly çš„ make_subplots å»ºç«‹åŒ…å« 2 å€‹å­åœ–çš„åœ–è¡¨
    # rows=2: å…©å€‹å­åœ–å‚ç›´æ’åˆ—
    # shared_xaxes=True: å…±ç”¨ x è»¸ï¼ˆæ™‚é–“è»¸ï¼‰
    # vertical_spacing: å­åœ–é–“çš„å‚ç›´é–“è·
    # row_width: å„å­åœ–çš„é«˜åº¦æ¯”ä¾‹
    fig = make_subplots(
        rows=2, cols=1, 
        shared_xaxes=True, 
        vertical_spacing=0.03, 
        subplot_titles=('K ç·šèˆ‡å‡ç·š', 'æˆäº¤é‡'),
        row_width=[0.2, 0.7]  # Kç·šåœ–ä½” 70%ï¼Œæˆäº¤é‡åœ–ä½” 20%
    )

    # ------------------------------------------------------------
    # 5.2 ç¹ªè£½ K æ£’
    # ------------------------------------------------------------
    # ä½¿ç”¨ Candlestick åœ–è¡¨é¡å‹ç¹ªè£½ K ç·š
    # ç¬¦åˆå°ç£ç¿’æ…£ï¼šç´…æ¼²ï¼ˆincreasingï¼‰ã€ç¶ è·Œï¼ˆdecreasingï¼‰
    candlestick = go.Candlestick(
        x=x_range,            # ä½¿ç”¨é€£çºŒæ•¸å­—ç´¢å¼•ä»£æ›¿æ—¥æœŸ
        open=df['Open'],      # é–‹ç›¤åƒ¹
        high=df['High'],      # æœ€é«˜åƒ¹
        low=df['Low'],        # æœ€ä½åƒ¹
        close=df['Close'],    # æ”¶ç›¤åƒ¹
        name='Kæ£’',
        increasing_line_color='red',   # ä¸Šæ¼²é¡¯ç¤ºç´…è‰²
        decreasing_line_color='green', # ä¸‹è·Œé¡¯ç¤ºç¶ è‰²
        text=date_labels,     # å°‡æ—¥æœŸä½œç‚ºæ–‡å­—è³‡è¨Š
        hovertext=date_labels # æ‡¸åœæ™‚é¡¯ç¤ºæ—¥æœŸ
    )
    # å°‡ K æ£’åŠ å…¥ç¬¬ä¸€å€‹å­åœ–ï¼ˆrow=1ï¼‰
    fig.add_trace(candlestick, row=1, col=1)

    # ------------------------------------------------------------
    # 5.3 ç¹ªè£½ç§»å‹•å¹³å‡ç·š (MA)
    # ------------------------------------------------------------
    # ç¹ªè£½ 10 æ—¥ç§»å‹•å¹³å‡ç·šï¼ˆæ©˜è‰²ï¼‰
    fig.add_trace(
        go.Scatter(
            x=x_range,  # ä½¿ç”¨é€£çºŒæ•¸å­—ç´¢å¼•
            y=df['MA10'], 
            line=dict(color='orange', width=1.5), 
            name='10 MA',
            text=date_labels,
            hovertext=date_labels
        ), 
        row=1, col=1
    )
    
    # ç¹ªè£½ 20 æ—¥ç§»å‹•å¹³å‡ç·šï¼ˆç´«è‰²ï¼‰
    fig.add_trace(
        go.Scatter(
            x=x_range,  # ä½¿ç”¨é€£çºŒæ•¸å­—ç´¢å¼•
            y=df['MA20'], 
            line=dict(color='purple', width=1.5), 
            name='20 MA',
            text=date_labels,
            hovertext=date_labels
        ), 
        row=1, col=1
    )

    # ------------------------------------------------------------
    # 5.4 ç¹ªè£½æˆäº¤é‡æŸ±ç‹€åœ–
    # ------------------------------------------------------------
    # æˆäº¤é‡çš„é¡è‰²æ ¹æ“šKæ£’çš„æ¼²è·Œï¼šæ¼²ç´…è·Œç¶ 
    # åˆ©ç”¨åˆ—è¡¨æ¨å°å¼ç”Ÿæˆé¡è‰²åˆ—è¡¨
    colors = ['red' if row['Open'] - row['Close'] >= 0 else 'green' 
              for index, row in df.iterrows()]
    
    # å»ºç«‹æŸ±ç‹€åœ–ä¸¦åŠ å…¥ç¬¬äºŒå€‹å­åœ–ï¼ˆrow=2ï¼‰
    fig.add_trace(
        go.Bar(
            x=x_range,  # ä½¿ç”¨é€£çºŒæ•¸å­—ç´¢å¼•
            y=df['Volume'], 
            marker_color=colors, 
            name='æˆäº¤é‡',
            text=date_labels,
            hovertext=date_labels
        ), 
        row=2, col=1
    )

    # ------------------------------------------------------------
    # 5.5 åœ–è¡¨ç¾åŒ–èˆ‡æ ¼å¼è¨­å®š
    # ------------------------------------------------------------
    # æ¨¡æ“¬å°ˆæ¥­çœ‹ç›¤è»Ÿé«”çš„æ·±è‰²é¢¨æ ¼
    fig.update_layout(
        xaxis_rangeslider_visible=False,  # éš±è—ä¸‹æ–¹æ»‘å‹•æ¢ä»¥ç¯€çœç©ºé–“
        height=700,                       # åœ–è¡¨é«˜åº¦ 700 åƒç´ 
        plot_bgcolor='rgb(20, 20, 20)',  # ç¹ªåœ–å€èƒŒæ™¯è‰²ï¼ˆæ·±ç°è‰²ï¼‰
        paper_bgcolor='rgb(20, 20, 20)', # æ•´å€‹ç•«å¸ƒèƒŒæ™¯è‰²
        font=dict(color='white'),         # å­—é«”é¡è‰²ï¼ˆç™½è‰²ï¼‰
        title_text=f"{product_option} - {session_option} - {interval_option} Kç·šåœ–",
        hovermode='x unified'             # æ»‘é¼ æ‡¸åœæ™‚é¡¯ç¤ºåå­—ç·šå’Œçµ±ä¸€æç¤º
    )
    
    # ------------------------------------------------------------
    # 5.5.1 è¨­å®š x è»¸é¡¯ç¤ºå¯¦éš›æ—¥æœŸï¼ˆæ¯éš”ä¸€æ®µé¡¯ç¤ºï¼‰
    # ------------------------------------------------------------
    # è¨ˆç®—è¦é¡¯ç¤ºçš„åˆ»åº¦ä½ç½®ï¼ˆé¿å…éæ–¼å¯†é›†ï¼‰
    tick_spacing = max(1, len(df) // 10)  # å¤§ç´„é¡¯ç¤º 10 å€‹åˆ»åº¦
    tickvals = list(range(0, len(df), tick_spacing))
    ticktext = [date_labels[i] for i in tickvals]
    
    # æ›´æ–° x è»¸è¨­å®š
    fig.update_xaxes(
        tickvals=tickvals,
        ticktext=ticktext,
        tickangle=-45  # æ–œå‘é¡¯ç¤ºä»¥é¿å…é‡ç–Š
    )
    
    # ------------------------------------------------------------
    # 5.6 é¡¯ç¤ºåœ–è¡¨
    # ------------------------------------------------------------
    # width='stretch' è®“åœ–è¡¨è‡ªå‹•ä¼¸å±•å¡«æ»¿å®¹å™¨å¯¬åº¦
    st.plotly_chart(fig, width='stretch')

    # ------------------------------------------------------------
    # 5.7 æœ€æ–°å ±åƒ¹è³‡è¨Šé¡¯ç¤º
    # ------------------------------------------------------------
    # å–å¾—æœ€å¾Œä¸€ç­†è³‡æ–™ï¼ˆæœ€æ–°çš„ K æ£’ï¼‰
    last_row = df.iloc[-1]
    
    # ä½¿ç”¨ Streamlit çš„ columns åŠŸèƒ½å»ºç«‹ 4 å€‹ä¸¦æ’çš„æ¬„ä½
    col1, col2, col3, col4 = st.columns(4)
    
    # åœ¨å„æ¬„ä½ä¸­é¡¯ç¤ºæŒ‡æ¨™ï¼ˆä½¿ç”¨ metric çµ„ä»¶ï¼‰
    col1.metric("æœ€æ–°æ”¶ç›¤", f"{last_row['Close']:.0f}")  # æœ€æ–°æ”¶ç›¤åƒ¹
    col2.metric("10 MA", f"{last_row['MA10']:.0f}")           # 10æ—¥å‡ç·š
    col3.metric("20 MA", f"{last_row['MA20']:.0f}")           # 20æ—¥å‡ç·š
    col4.metric("æˆäº¤é‡", f"{last_row['Volume']:.0f}")        # æˆäº¤é‡

else:
    # ------------------------------------------------------------
    # ç•¶æ•¸æ“šç²å–å¤±æ•—æ™‚é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    # ------------------------------------------------------------
    st.error("ç›®å‰ç„¡æ³•ç²å–æ•¸æ“šï¼Œè«‹ç¢ºèªå¸‚å ´æ˜¯å¦é–‹ç›¤æˆ–æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚")

# ============================================================
# ç¨‹å¼çµæŸ
# ============================================================
# %% è¨˜è™Ÿç”¨æ–¼ Jupyter/IPython ç’°å¢ƒä¸­å€åˆ†ä»£ç¢¼å€å¡Š
