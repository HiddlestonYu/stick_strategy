# Shioaji TXFR1 數據差異說明

## 📊 問題摘要

使用 Shioaji API 的 **TXFR1 連續合約**抓取台指期貨歷史數據時，發現與元大證券 APP 顯示的數據有顯著差異。

## 🔍 測試結果

### 2026-01-30 數據比對

| 項目 | Shioaji TXFR1 | 元大 APP | 差異 |
|------|---------------|----------|------|
| 開盤 | 32171 | 32456 | -285 點 |
| 最高 | 32466 | 32526 | -60 點 |
| 最低 | 32135 | 32092 | +43 點 |
| **收盤** | **32443** | **32247** | **+196 點** |
| 最後時間 | 12:59:59 | 13:45 | 缺45分鐘 |

### 2026-01-27 ~ 01-29 數據比對

✅ **完全一致** - 前三個交易日的收盤價與元大 APP 完全相同：
- 01/27: 32288 ✅
- 01/28: 32696 ✅
- 01/29: 33015 ✅

## ❌ 已知限制

### 1. 歷史 Ticks 缺少 13:00-13:45 數據

```python
# 使用 api.ticks() 抓取的數據統計
時段分布:
   08:00-08:59: 6,865 筆
   09:00-12:59: 8,504 筆
   13:00-13:45: 0 筆 ❌  # 完全沒有資料！
   15:00-23:59: 47,989 筆（夜盤）
```

**影響**：
- 無法取得正確的收盤價（13:45 收盤）
- 最後一筆只到 12:59:59
- 當日最高/最低可能不準確

### 2. 01-30 全部 OHLC 都不對

不只是缺少 13:00-13:45，連**開盤價、日內高低點**都與元大 APP 不一致，可能原因：
- TXFR1 連續合約的定義與元大不同
- Shioaji 使用的數據源與券商 APP 不同
- 結算日附近的合約切換時機不同

## ✅ 目前架構

### 使用 TXFR1 連續合約（已實施）

```python
# 所有程式已統一使用 TXFR1
contract = api.Contracts.Futures.TXF.TXFR1

# fetch_real_ticks.py - 歷史數據
# realtime_ticks_subscriber.py - 即時訂閱
# streamlit_run_app.py - 從資料庫讀取
```

**優點**：
- ✅ 自動在結算日切換到次月合約
- ✅ 不需手動判斷月份
- ✅ 符合 Shioaji 官方文件建議

**缺點**：
- ❌ 歷史數據不完整（缺13:00-13:45）
- ❌ 與券商 APP 數據有差異

## 🔧 解決方案

### 方案一：接受 Shioaji 數據（目前採用）

**適用場景**：
- 只需要大致的歷史數據分析
- 不做即時交易決策
- 能容忍 ±200 點的誤差

**實施狀況**：
- ✅ 已統一使用 TXFR1
- ✅ 資料庫架構完成
- ✅ 批次儲存效能優化
- ⚠️ 數據不準確

### 方案二：使用即時訂閱（建議）

**在市場時段使用即時 ticks**：

```python
# realtime_ticks_subscriber.py
# 在交易時段執行，訂閱即時 ticks
# 即時數據應該包含完整的 08:45-13:45

python realtime_ticks_subscriber.py
```

**優點**：
- ✅ 即時數據完整（有 13:00-13:45）
- ✅ 數據應與券商一致
- ✅ 適合實盤交易

**缺點**：
- ❌ 必須在市場時段執行
- ❌ 無法補歷史數據

### 方案三：使用其他數據源

考慮使用：
- **Yahoo Finance** (^TWII) - 現貨指數
- **其他券商 API** - 元大、群益等
- **付費數據源** - XQ全球贏家、CMoney等

## 📝 目前資料庫狀態

```
資料庫: data/txf_ticks.db

合約代碼:
   TXFB6  - 36,311 筆（舊資料，可刪除）
   TXFR1  - 79,344 筆（新資料）

2026-01-30:
   TXFR1  - 51,735 筆
   時間範圍: 08:45 - 12:59 (UTC: 00:00 - 13:44)
   ⚠️ 缺少 13:00-13:45
```

## 🎯 建議做法

1. **繼續使用 TXFR1** - 這是最正確的合約選擇
2. **文檔化已知限制** - 讓使用者知道數據差異
3. **市場時段用即時訂閱** - 需要準確數據時執行 `realtime_ticks_subscriber.py`
4. **觀察更多交易日** - 確認 01-27~01-29 的準確性是常態還是特例

## 📅 測試日期

- **測試時間**: 2026-02-01 23:18
- **測試合約**: TXFR1 (連續近月合約)
- **測試日期**: 2026-01-26 ~ 2026-01-30
- **數據來源**: Shioaji API 1.3.1

---

**結論**: Shioaji TXFR1 的歷史數據與元大 APP 有差異，尤其是 13:00-13:45 時段完全缺失。建議在實盤交易時使用即時訂閱，歷史分析則接受這個限制。
